;
;
;
;




; 32 TAP FILTER
start:

.dseg

    FILTERCOEFFICIENTS: .byte 32; 32 bytes to store the filter coefficients
	BUFFER : .byte 32 ; 32 bytes to store the filter coefficients
	SRAMRESULT: .byte 900 ; Allocating 900 bytes in the SRAM for storing output  ; X will deal with this...

.CSEG
    
	LDI R16,9
	LDI R17,100
	MOV R5,R16
	MOV R6,R17

	LDI ZL,LOW(2*SINE);   Pointer to the data values (samples of the signal).. has been hardwired for Sin. For other signals, replace SINE with the required signal and uncomment the definition at the end
	LDI ZH,HIGH(2*SINE);


	LDI XL,LOW(SRAMRESULT); Pointer to the SRAM Location (to store the RESULT)
	LDI XH,HIGH(SRAMRESULT);
	
	MOV R7,R26
	MOV R8,R27

	LDI XL,LOW(FILTERCOEFFICIENTS); Pointer to the SRAM Location (to store the filter coefficients) 
	LDI XH,HIGH(FILTERCOEFFICIENTS);

	MOV R24,R26; Copy of pointer to the first filter coefficients
	MOV R25,R27; 

	; We would now load the filter coefficients to the SRAM 
	LDI R16,247
	ST X+,R16
	LDI R16,249
	ST X+,R16
	LDI R16,4
	ST X+,R16
	LDI R16,245
	ST X+,R16
	LDI R16,0
	ST X+,R16
	LDI R16,255
	ST X+,R16
	LDI R16,3
	ST X+,R16
	LDI R16,8
	ST X+,R16
	LDI R16,1
	ST X+,R16
	LDI R16,0
	ST X+,R16
	LDI R16,0
	ST X+,R16
	LDI R16,245
	ST X+,R16
	LDI R16,0
	ST X+,R16
	LDI R16,242
	ST X+,R16
	LDI R16,234
	ST X+,R16
	LDI R16,36
	ST X+,R16
	LDI R16,36
	ST X+,R16
	LDI R16,234
	ST X+,R16
	LDI R16,242
	ST X+,R16
	LDI R16,0
	ST X+,R16
	LDI R16,245
	ST X+,R16
	LDI R16,0
	ST X+,R16
	LDI R16,0
	ST X+,R16
	LDI R16,1
	ST X+,R16
	LDI R16,8
	ST X+,R16
	LDI R16,3
	ST X+,R16
	LDI R16,255
	ST X+,R16
	LDI R16,0
	ST X+,R16
	LDI R16,245
	ST X+,R16
	LDI R16,4
	ST X+,R16
	LDI R16,249
	ST X+,R16
	LDI R16,247
	ST X+,R16


	; Completed loading all the filter coeffients into the memory.. (starting at the location 0x60)

	;Resetting the pointer X to store the location of the first filter coefficient
	
	MOV XL,R24;
	MOV XH,R25; 

	;NOTE: R0:R1 stores the result of fmuls 
	
	LDI R16,0; Just for cleanup.. resetting values to 0
	MOV R0,R16
	MOV R1,R16

	;R20,21 are accumulators in reverse order
	

	LDI YL,LOW(BUFFER)
	LDI YH,HIGH(BUFFER); Setting the pointer to point to the beginning of the buffer

	MOV R14,R28
	MOV R15,R29; R14:R15 now points to start of buffer
	
	MOV R9,R14
	MOV R10,R15
	LDI R16,31;
	LDI R17,0;
	ADD R9,R16
	ADC R10,R17; R9:R10 now points to the end of the buffer    	
	LDI R17,32; Store the first set of 32 samples into the buffer

TAP32:
	
	LPM R16,Z+; 
	ST Y+,R16;
	DEC R17;
	BRNE TAP32

	
	;LDI R21,16; POINTER TO THE ONE TO BE REPLACED
	;LDI R22,20; POINTER TO THE END/BEGINNING OF BUFFER (VARIABLE)

	; RESETTING POINTER Y TO POINT TO THE OLDEST SAMPLE IN THE BUFFER
	LDI YL,LOW(BUFFER)
	LDI YH,HIGH(BUFFER)
	LPM R16, Z+;
	ST Y,R16;

	RJMP COMPUTER

	;LPM R17,Z+;
	;LPM R18,Z+;
	;LPM R19,Z+;
	;LPM R20,Z+; Bottom of the buffer

LOADNEWDATAPOINT:
	LPM R16, Z+;
	;COMPARE Y WITH END OF BUFFER... INCREMENT IF NOT YET REACHED END; ELSE SET TO BEGINNING... THEN LOAD DATA

	MOV XL,R24; Resetting X to point to the first filter coefficient
	MOV XH,R25; 

	LDI R20,0
	LDI R21,0; Resetting the accumulator to 0

	MOV R12,R28;
	SUB R12,R9;
	BREQ ENDOFBUFFER
	LDI R17,1
	LDI R18,0
	ADD R28,R17
	ADC R29,R18
	
GEN:
	ST Y,R16;
	RJMP COMPUTER;

ENDOFBUFFER: 
	MOV R28,R14; Reset the pointer   
	MOV R29,R15
	RJMP GEN;

COMPUTER:
	
	;MOV R24,R21;
	;As we loaded and haven't incremented, R21 points to the latest entry...
	;LDI R28,11; POINTER TO THE FILTER COEFFICIENT OF THE PRESENT TAP
	LDI R17,32 ; NO. OF TAPS

	;LD R18,Y; Load the latest sample into the register R18
	;MOV R12,R28;
	;MOV R13,R29; Stores the latest entry location of the buffer 

REPEAT:

	LD R18,Y; Load the latest sample into the register R18	
	MOV R12,R28;
	MOV R13,R29; Stores the latest entry location of the buffer 
	LD R19,X+; Load the filter coefficient into r19
	FMULS R18,R19;
    ADD R20,R0;
	ADC R21,R1; Storing the result of the fractional multiplication in our virtual accumulator
	; our accumulator is 16 bit, as there won't be any overflow since filter coefficients are scaled
	
	;MOV R23,R24;  just a copy to check the pointer location
	;LDI R22,16
	;SUB R23,R22;
	SUB R12,R14
	BREQ RESETLOOPCOUNTER
	
	LD R18,-Y; Load the NEXT sample TO BE MULTIPLIED into the register R18	

REGULAR:

	DEC R17; DECREMENTING THE TAP COUNT TO GO UPTIL 32
	BRNE REPEAT;
	RJMP ENDOFPOINT; AFTER THE END OF 32 TAPS, GO TO END OF POINT

RESETLOOPCOUNTER:
	MOV R28,R9
	MOV R29,R10 ; Resetting the pointer to the end of the buffer
	LD R18,Y; Load the NEXT sample TO BE MULTIPLIED into the register R18	

	RJMP REGULAR	 

ENDOFPOINT:

	
	;Taking THE OUTPUT TO ONLY 8 bit, i.e. taking only the higher 7 bits of decimal in the Q1.15 format to retain Q1.7 format

	MOV XL,R7
	MOV XH,R8;
	ST X+,R21;
	MOV R7,R26;
	MOV R8,R27
	
	DEC R5
	BREQ NEXT
	RJMP LOADNEWDATAPOINT;
NEXT:
	LDI R16,9
	MOV R5,R16
	DEC R6			; decrementing the counter (while running through the 900 samples)
	BREQ THEEND
	RJMP LOADNEWDATAPOINT;

THEEND:
	
	NOP;







; Define inputs using .db directive (1000 samples)

SINE : .db 0,202,158,132,129,149,188,240,39,86,118,127,114,79,30,231,181,144,128,135,164,210,8,61,102,125,124,101,59,6,208,163,134,128,145,183,233,32,81,115,127,117,85,37,238,187,148,129,133,159,204,1,55,98,123,126,105,65,13,215,168,137,128,142,177,226,25,75,111,127,119,90,43,245,193,152,130,131,155,197,250,48,93,121,127,109,71,20,221,173,140,128,139,172,220,18,70,108,126,122,94,50,252,199,156,131,130,151,191,243,42,88,119,127,112,77,27,228,178,143,128,136,167,213,12,64,104,125,124,99,56,3,205,161,133,129,147,185,237,35,83,116,127,115,82,34,235,184,146,128,134,162,207,5,58,100,124,125,103,62,10,212,165,136,128,144,180,230,29,78,113,127,118,87,40,242,190,150,129,132,157,200,254,51,96,122,126,107,68,17,218,170,138,128,140,174,223,22,72,110,127,121,92,47,249,196,154,131,130,153,194,247,45,91,120,127,111,74,24,225,176,141,128,137,169,216,15,67,106,126,123,97,53,255,202,158,132,129,149,188,240,39,86,118,127,114,79,30,231,181,144,128,135,164,210,8,61,102,125,124,101,59,6,208,163,134,128,145,183,233,32,81,115,127,117,85,37,238,187,148,129,133,159,204,1,55,98,123,126,105,65,13,215,168,137,128,142,177,226,25,75,111,127,119,90,43,245,193,152,130,131,155,197,250,48,93,121,127,109,71,20,221,173,140,128,139,172,220,18,70,108,126,122,94,50,252,199,156,131,130,151,191,243,42,88,119,127,112,77,27,228,178,143,128,136,167,213,12,64,104,125,124,99,56,3,205,161,133,129,147,185,237,35,83,116,127,115,82,34,235,184,146,128,134,162,207,5,58,100,124,125,103,62,10,212,165,136,128,144,180,230,29,78,113,127,118,87,40,242,190,150,129,132,157,200,254,51,96,122,126,107,68,17,218,170,138,128,140,174,223,22,72,110,127,121,92,47,249,196,154,131,130,153,194,247,45,91,120,127,111,74,24,225,176,141,128,137,169,216,15,67,106,126,123,97,53,255,202,158,132,129,149,188,240,39,86,118,127,114,79,30,231,181,144,128,135,164,210,8,61,102,125,124,101,59,6,208,163,134,128,145,183,233,32,81,115,127,117,85,37,238,187,148,129,133,159,204,1,55,98,123,126,105,65,13,215,168,137,128,142,177,226,25,75,111,127,119,90,43,245,193,152,130,131,155,197,250,48,93,121,127,109,71,20,221,173,140,128,139,172,220,18,70,108,126,122,94,50,252,199,156,131,130,151,191,243,42,88,119,127,112,77,27,228,178,143,128,136,167,213,12,64,104,125,124,99,56,3,205,161,133,129,147,185,237,35,83,116,127,115,82,34,235,184,146,128,134,162,207,5,58,100,124,125,103,62,10,212,165,136,128,144,180,230,29,78,113,127,118,87,40,242,190,150,129,132,157,200,254,51,96,122,126,107,68,17,218,170,138,128,140,174,223,22,72,110,127,121,92,47,249,196,154,131,130,153,194,247,45,91,120,127,111,74,24,225,176,141,128,137,169,216,15,67,106,126,123,97,53,0,202,158,132,129,149,188,240,39,86,118,127,114,79,30,231,181,144,128,135,164,210,8,61,102,125,124,101,59,6,208,163,134,128,145,183,233,32,81,115,127,117,85,37,238,187,148,129,133,159,204,1,55,98,123,126,105,65,13,215,168,137,128,142,177,226,25,75,111,127,119,90,43,245,193,152,130,131,155,197,250,48,93,121,127,109,71,20,221,173,140,128,139,172,220,18,70,108,126,122,94,50,252,199,156,131,130,151,191,243,42,88,119,127,112,77,27,228,178,143,128,136,167,213,12,64,104,125,124,99,56,3,205,161,133,129,147,185,237,35,83,116,127,115,82,34,235,184,146,128,134,162,207,5,58,100,124,125,103,62,10,212,165,136,128,144,180,230,29,78,113,127,118,87,40,242,190,150,129,132,157,200,254,51,96,122,126,107,68,17,218,170,138,128,140,174,223,22,72,110,127,121,92,47,249,196,154,131,130,153,194,247,45,91,120,127,111,74,24,225,176,141,128,137,169,216,15,67,106,126,123,97,53

;WHITENOISE : .db 228,243,42,231,65,198,80,7,164,29,162,14,95,248,20,28,240,34,240,37,213,2,243,223,3,193,186,194,222,35,2,52,41,235,198,1,241,51,225,66,10,19,225,213,248,0,194,4,223,17,41,176,225,244,160,146,184,37,68,229,236,7,34,37,105,19,206,97,213,226,38,7,2,0,199,201,185,31,218,182,20,245,200,12,18,21,230,241,237,6,21,69,230,229,248,49,239,39,224,219,76,36,23,0,230,49,47,181,207,240,62,16,55,231,20,229,176,13,1,223,232,223,21,212,25,243,246,218,220,227,217,226,228,191,182,123,23,214,9,239,35,16,62,10,22,240,217,183,198,74,201,21,2,29,246,244,26,242,10,59,26,230,244,59,180,13,65,0,8,40,97,40,232,0,227,0,152,213,23,20,199,21,8,44,8,216,218,203,10,35,238,242,232,163,202,238,13,220,204,209,33,11,6,32,36,229,183,194,38,19,197,238,253,4,253,220,46,234,215,173,202,116,230,62,234,43,230,225,14,6,29,234,23,226,34,28,12,211,186,230,5,191,21,68,236,249,212,253,218,43,32,9,244,68,164,14,28,1,55,222,2,57,218,53,181,246,60,23,255,10,217,192,167,25,174,16,179,21,11,7,239,53,35,203,233,17,239,45,202,22,30,14,10,198,70,250,202,214,194,216,25,242,8,34,227,31,248,243,13,248,231,71,2,0,238,193,52,215,4,2,48,245,221,232,5,247,193,43,235,106,255,245,3,9,23,110,173,213,227,13,240,23,197,48,11,13,204,230,6,223,34,229,222,19,218,40,192,225,85,220,236,11,15,123,59,234,28,60,253,153,243,201,24,251,44,213,48,206,63,7,50,195,36,230,191,53,17,249,9,235,198,166,183,236,28,251,5,236,13,34,224,202,22,228,162,10,25,29,15,252,5,81,1,241,58,48,72,40,23,58,248,243,221,73,99,42,231,205,217,2,201,190,192,19,169,20,17,211,216,231,229,35,249,220,21,41,183,50,212,173,3,47,51,239,29,250,247,48,10,40,20,228,23,249,204,8,255,233,4,220,80,188,190,44,223,228,229,37,5,20,177,180,9,176,80,13,55,181,22,20,48,241,198,225,233,242,246,10,88,220,227,74,104,225,175,20,226,252,251,13,200,10,238,193,250,211,120,2,251,246,251,51,197,223,42,19,247,57,251,40,255,75,35,27,219,237,16,12,195,11,14,181,207,61,233,208,240,52,18,160,232,188,230,175,28,43,35,42,52,221,234,197,172,216,200,2,240,18,216,14,8,186,173,157,228,3,21,213,238,160,75,222,15,188,235,40,204,21,206,27,20,250,75,188,22,75,13,29,248,37,180,208,209,207,101,73,229,18,186,226,243,12,50,26,255,52,248,27,85,206,244,214,189,41,236,184,212,41,27,4,189,234,215,56,228,35,71,56,26,201,98,200,227,255,31,11,222,213,192,239,243,250,239,21,250,231,244,69,2,44,239,226,58,25,230,58,246,253,253,249,11,195,23,152,255,208,19,213,36,226,216,11,240,233,232,35,235,251,230,248,222,21,11,35,10,13,8,65,250,240,11,239,200,230,232,19,22,247,9,218,251,243,29,36,232,174,2,49,47,26,41,216,202,19,249,205,29,58,11,11,5,226,0,36,207,40,53,252,251,57,20,18,249,221,236,17,217,254,224,199,68,36,247,48,3,19,18,12,0,255,225,49,243,254,210,1,63,209,30,194,22,64,5,207,72,211,227,18,15,252,10,18,248,11,240,234,234,3,213,226,250,15,247,255,229,191,230,230,60,43,21,51,3,231,36,227,223,22,231,211,222,229,198,224,22,91,231,25,75,255,239,8,8,221,4,230,209,5,37,25,0,29,45,250,242,30,255,78,201,192,211,5,253,245,39,249,21,68,48,235,93,41,9,211,71,251,251,1,9,93,57,252,67,241,210,236,230,250,253,34,226,42,243,21,77,5,21,226,9,222,248,226,3,218,36,11,201,173,192,216,255,16,204,180,234,183,245,207,18,229,2,215,73,3,244,199,14,209,206,226,227,229,70,27,57,142,244,249,242,69,234,221,13,203,68,42,98,23,8,52,5,255,216,223,254,27,41,228,236,218,203,12,243,56,237,36,234,19,51,248,9,144,236,8,4,70,14,255,22,201,236,20,246,154,30,198,202,17,245,223,189,229,163,14,252,200,247,124,9,16,68,16,0,3,13,45,12,49,251,34,234,36,206,236,234,76,213,203,11,204

;DC : .db 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128

